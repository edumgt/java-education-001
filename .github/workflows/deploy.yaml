name: "Java Compile + CodeQL Analysis"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  analyze:
    runs-on: ubuntu-latest

    permissions:
      actions: read
      contents: write
      security-events: write

    steps:
      # 1. ì†ŒìŠ¤ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. JDK ì„¤ì¹˜
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. ì „ì²´ ì†ŒìŠ¤ ì»´íŒŒì¼ ì‹œë„
      - name: Compile all Java sources
        run: |
          mkdir -p bin
          echo "ğŸš€ Compiling all Java files..."
          if ! javac -d bin $(find . -name "*.java") 2> compile_errors.log; then
            echo "âŒ Compilation errors detected."
            cat compile_errors.log

            # ì—ëŸ¬ë‚œ java íŒŒì¼ë§Œ ì¶”ì¶œ
            grep -oP '^[^:]+\.java' compile_errors.log | sort -u > error_files.txt

            echo "âš ï¸ ì˜¤ë¥˜ë‚œ íŒŒì¼ ëª©ë¡:"
            cat error_files.txt

            # ì˜¤ë¥˜ë‚œ íŒŒì¼ì„ *_update.java ë¡œ ë³µì‚¬
            while read -r file; do
              if [ -f "$file" ]; then
                cp "$file" "${file%.java}_update.java"
                echo "â¡ï¸ Created: ${file%.java}_update.java"
              fi
            done < error_files.txt
          else
            echo "âœ… All Java files compiled successfully."
          fi

      # 4. CodeQL ì´ˆê¸°í™” (ì •ì  ë¶„ì„)
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java
          build-mode: none   # ë¹Œë“œ ìŠ¤í‚µ, ì†ŒìŠ¤ë§Œ ì •ì  ë¶„ì„

      # 5. CodeQL ì‹¤í–‰
      - name: Run CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          output: results

      # 6. ì˜¤ë¥˜ë‚œ íŒŒì¼(_update.java) commit/push
      - name: Commit update.java files
        run: |
          git config --global user.name "edumgt"
          git config --global user.email "kimdypm@gmail.com"

          if ls **/*_update.java 1> /dev/null 2>&1; then
            git add **/*_update.java
            git commit -m "Add _update.java files (compile errors)" || echo "No changes"
            git push
          else
            echo "âœ… No compile errors. Nothing to commit."
          fi
